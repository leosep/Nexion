@* DatingApp.Web/Views/User/Descubrir.cshtml *@

@model IEnumerable<DatingApp.Web.ViewModels.UserViewModel>
@using System.Security.Claims
@using System.Text.Json

@{
    ViewData["Title"] = "Descubrir";
    Layout = "_Layout";
}

<style>
    /* Swipe card styles */
    .swipe-container {
        position: relative;
        width: 100%;
        height: calc(100vh - 200px);
        min-height: 600px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        perspective: 1000px;
        margin: 0 auto;
    }

    .swipe-card {
        position: absolute;
        width: 90%;
        max-width: 400px;
        height: 550px;
        max-height: 80vh;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        transition: transform 0.6s cubic-bezier(0.23, 1, 0.320, 1), opacity 0.6s ease;
        cursor: grab;
        transform-style: preserve-3d;
    }

    .swipe-card.dragging {
        cursor: grabbing;
        transition: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    .swipe-card.swipe-left {
        transform: translateX(-300px) translateY(-100px) rotate(-30deg) scale(0.8);
        opacity: 0;
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.8s ease;
    }

    .swipe-card.swipe-right {
        transform: translateX(300px) translateY(-100px) rotate(30deg) scale(0.8);
        opacity: 0;
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.8s ease;
    }

    .swipe-card.bounce-back {
        animation: bounceBack 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @@keyframes bounceBack {
        0% { transform: translateX(0) rotate(0deg) scale(1); }
        25% { transform: translateX(20px) rotate(2deg) scale(1.02); }
        50% { transform: translateX(-10px) rotate(-1deg) scale(1.01); }
        75% { transform: translateX(5px) rotate(0.5deg) scale(1.005); }
        100% { transform: translateX(0) rotate(0deg) scale(1); }
    }

    .card-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        transition: filter 0.3s ease;
    }

    .card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        border-radius: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-overlay.like {
        background: linear-gradient(45deg, rgba(76, 175, 80, 0.8), rgba(139, 195, 74, 0.8));
    }

    .card-overlay.dislike {
        background: linear-gradient(45deg, rgba(244, 67, 54, 0.8), rgba(255, 87, 34, 0.8));
    }

    .overlay-icon {
        font-size: 80px;
        color: white;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: scale(0);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .card-overlay.like .overlay-icon {
        transform: scale(1) rotate(20deg);
    }

    .card-overlay.dislike .overlay-icon {
        transform: scale(1) rotate(-20deg);
    }

    .card-content {
        padding: 20px;
        height: 250px;
        overflow-y: auto;
        position: relative;
    }

    .action-buttons {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 40px;
        z-index: 1000;
        pointer-events: auto;
    }

    .action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        position: relative;
        overflow: hidden;
    }

    /* Mobile responsive adjustments */
    @@media (max-width: 768px) {
        .action-buttons {
            bottom: 100px;
            gap: 30px;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }

        .swipe-progress {
            bottom: 170px;
            width: 150px;
        }

        .swipe-container {
            height: calc(100vh - 150px);
            min-height: 500px;
        }
    }

    @@media (max-width: 480px) {
        .action-buttons {
            bottom: 80px;
            gap: 25px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }

        .swipe-progress {
            bottom: 140px;
            width: 120px;
        }

        .swipe-container {
            height: calc(100vh - 120px);
            min-height: 400px;
        }
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }

    .action-btn:hover::before {
        width: 120px;
        height: 120px;
    }

    .dislike-btn {
        background: linear-gradient(135deg, #ff6b9d 0%, #c44569 50%);
        color: white;
    }

    .like-btn {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .no-users {
        text-align: center;
        color: #666;
        font-size: 18px;
        animation: fadeInUp 0.8s ease;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .photo-indicator {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 5px;
        z-index: 5;
    }

    .photo-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .photo-dot.active {
        background: white;
        transform: scale(1.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    /* Progress indicator for swipe */
    .swipe-progress {
        position: fixed;
        bottom: 200px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 999;
    }

    .swipe-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff6b9d, #4facfe);
        border-radius: 2px;
        transform: translateX(-100%);
        transition: transform 0.1s ease;
    }
</style>

<div class="swipe-container" id="swipe-container">
    @if (!Model.Any())
    {
        <div class="no-users p-12 bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50 rounded-3xl border-2 border-dashed border-pink-200 shadow-xl">
            <i class="fas fa-heart-broken text-9xl text-pink-300 mb-8 animate-bounce"></i>
            <h3 class="text-5xl font-bold text-gray-700 mb-6">Â¡No hay mÃ¡s perfiles!</h3>
            <p class="text-2xl text-gray-600 mb-8 max-w-lg mx-auto leading-relaxed">Has visto todos los perfiles disponibles que coinciden con tus preferencias actuales.</p>
            <div class="space-y-6">
                <p class="text-xl text-gray-500 font-medium">Â¿QuÃ© te gustarÃ­a hacer ahora?</p>
                <div class="flex flex-col sm:flex-row gap-6 justify-center">
                    <a href="/User/Profile" class="inline-flex items-center px-10 py-5 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white font-bold text-lg rounded-full transition-all duration-300 transform hover:scale-105 shadow-xl">
                        <i class="fas fa-sliders-h mr-3 text-xl"></i>
                        Cambiar Preferencias
                    </a>
                    <a href="/User/Index" class="inline-flex items-center px-10 py-5 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold text-lg rounded-full transition-all duration-300 transform hover:scale-105 shadow-xl">
                        <i class="fas fa-search mr-3 text-xl"></i>
                        Ver Explorar
                    </a>
                </div>
                <p class="text-lg text-gray-400 mt-8">ðŸ’¡ <strong>Tip:</strong> Actualiza tus preferencias para encontrar mÃ¡s personas compatibles</p>
            </div>
        </div>
    }
    else
    {
        @foreach (var user in Model)
        {
            <div class="swipe-card" data-user-id="@user.Id" data-user-photos="@string.Join(",", user.ProfilePhotoUrls)">
                <div class="photo-indicator">
                    @for (int i = 0; i < user.ProfilePhotoUrls.Count; i++)
                    {
                        <div class="photo-dot @(i == 0 ? "active" : "")"></div>
                    }
                </div>
                <img src="@(user.ProfilePhotoUrls.Any() ? user.ProfilePhotoUrls[0] : "https://placehold.co/400x400/e2e8f0/718096?text=No+Foto")"
                     alt="Foto de @user.Username" class="card-image" />
                <div class="card-overlay like">
                    <i class="fas fa-heart overlay-icon"></i>
                </div>
                <div class="card-overlay dislike">
                    <i class="fas fa-times overlay-icon"></i>
                </div>
                <div class="card-content">
                    <h3 class="text-2xl font-bold text-gray-800">@user.Username</h3>
                    <p class="text-gray-600 mt-2">@user.Bio</p>
                    @if (!string.IsNullOrWhiteSpace(user.Interests))
                    {
                        <p class="text-gray-600 mt-2 text-sm font-medium">Intereses: @user.Interests</p>
                    }
                    @if (user.PromptAnswers != null && user.PromptAnswers.Any())
                    {
                        <div class="mt-4">
                            @foreach (var prompt in user.PromptAnswers)
                            {
                                if (!string.IsNullOrWhiteSpace(prompt.Value))
                                {
                                    <p class="text-xs text-gray-500 font-bold mb-1">
                                        @switch (prompt.Key)
                                        {
                                            case "IdealWeekend":
                                                <text>Mi fin de semana ideal es...</text>
                                                break;
                                            case "AlwaysLaughAt":
                                                <text>Siempre me rÃ­o cuando...</text>
                                                break;
                                            case "LifeGoal":
                                                <text>Algo que quiero hacer en mi vida es...</text>
                                                break;
                                        }
                                    </p>
                                    <p class="text-sm text-gray-700 italic mb-3">@prompt.Value</p>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

<div class="swipe-progress" id="swipe-progress">
    <div class="swipe-progress-bar" id="swipe-progress-bar"></div>
</div>

<div class="action-buttons">
    <button class="action-btn dislike-btn" id="dislike-btn">
        <i class="fas fa-times"></i>
    </button>
    <button class="action-btn like-btn" id="like-btn">
        <i class="fas fa-heart"></i>
    </button>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('swipe-container');
            const cards = Array.from(document.querySelectorAll('.swipe-card'));
            const dislikeBtn = document.getElementById('dislike-btn');
            const likeBtn = document.getElementById('like-btn');
            const progressBar = document.getElementById('swipe-progress-bar');
            const progressContainer = document.getElementById('swipe-progress');

            let currentCardIndex = 0;
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            let isDragging = false;
            let startTime = 0;
            let velocity = 0;

            const SWIPE_THRESHOLD = 120;
            const MAX_ROTATION = 25;
            const DAMPING = 0.95;

            function updateCardVisibility() {
                cards.forEach((card, index) => {
                    if (index === currentCardIndex) {
                        card.style.display = 'block';
                        card.style.transform = 'translateX(0) translateY(0) rotate(0deg) scale(1)';
                        card.style.opacity = '1';
                        resetCardState(card);
                    } else {
                        card.style.display = 'none';
                    }
                });
            }

            function resetCardState(card) {
                const overlays = card.querySelectorAll('.card-overlay');
                overlays.forEach(overlay => {
                    overlay.style.opacity = '0';
                    overlay.querySelector('.overlay-icon').style.transform = 'scale(0)';
                });
                progressContainer.style.opacity = '0';
                progressBar.style.transform = 'translateX(-100%)';
            }

            function updateCardTransform(card, x, y) {
                const rotate = Math.min(Math.max(x * 0.15, -MAX_ROTATION), MAX_ROTATION);
                const scale = Math.max(1 - Math.abs(x) * 0.001, 0.95);
                const translateY = Math.abs(x) * 0.1;

                card.style.transform = `translateX(${x}px) translateY(${y - translateY}px) rotate(${rotate}deg) scale(${scale})`;

                // Update overlays
                const likeOverlay = card.querySelector('.card-overlay.like');
                const dislikeOverlay = card.querySelector('.card-overlay.dislike');

                if (x > 50) {
                    likeOverlay.style.opacity = Math.min(x / SWIPE_THRESHOLD, 1);
                    likeOverlay.querySelector('.overlay-icon').style.transform = `scale(${Math.min(x / SWIPE_THRESHOLD, 1)}) rotate(20deg)`;
                    dislikeOverlay.style.opacity = '0';
                } else if (x < -50) {
                    dislikeOverlay.style.opacity = Math.min(-x / SWIPE_THRESHOLD, 1);
                    dislikeOverlay.querySelector('.overlay-icon').style.transform = `scale(${Math.min(-x / SWIPE_THRESHOLD, 1)}) rotate(-20deg)`;
                    likeOverlay.style.opacity = '0';
                } else {
                    likeOverlay.style.opacity = '0';
                    dislikeOverlay.style.opacity = '0';
                }

                // Update progress bar
                const progress = Math.min(Math.abs(x) / SWIPE_THRESHOLD, 1);
                if (progress > 0.1) {
                    progressContainer.style.opacity = '1';
                    progressBar.style.transform = `translateX(${-100 + progress * 100}%)`;
                    progressBar.style.background = x > 0
                        ? 'linear-gradient(90deg, #4facfe, #00f2fe)'
                        : 'linear-gradient(90deg, #ff6b9d, #c44569)';
                } else {
                    progressContainer.style.opacity = '0';
                }
            }

            function handleSwipe(direction, velocity = 0) {
                if (currentCardIndex >= cards.length) return;

                const card = cards[currentCardIndex];
                const isLike = direction === 'right';

                // Calculate final position based on velocity
                const finalX = isLike ? 400 : -400;
                const finalRotate = isLike ? 30 : -30;
                const duration = Math.max(300 - Math.abs(velocity) * 50, 200);

                card.style.transition = `transform ${duration}ms cubic-bezier(0.23, 1, 0.320, 1), opacity ${duration}ms ease`;
                card.style.transform = `translateX(${finalX}px) translateY(-100px) rotate(${finalRotate}deg) scale(0.8)`;
                card.style.opacity = '0';

                // Send interest request
                const userId = card.dataset.userId;
                sendInterest(userId, isLike);

                setTimeout(() => {
                    card.style.display = 'none';
                    currentCardIndex++;
                    updateCardVisibility();
                }, duration);
            }

            function handleBounceBack(card) {
                card.classList.add('bounce-back');
                resetCardState(card);

                setTimeout(() => {
                    card.classList.remove('bounce-back');
                    card.style.transform = 'translateX(0) translateY(0) rotate(0deg) scale(1)';
                }, 600);
            }

            async function sendInterest(targetUserId, isLike) {
                try {
                    const response = await fetch('/User/AddInterest', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ targetUserId: parseInt(targetUserId) })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success && result.isMatch) {
                        // Trigger confetti effect for match!
                        triggerConfetti();
                    } else if (!result.success) {
                        console.error('Error:', result.message);
                    }
                } catch (error) {
                    console.error('Error sending interest:', error);
                }
            }

            function triggerConfetti() {
                // Main confetti burst
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#ff6b9d', '#4facfe', '#ffeaa7', '#fd79a8', '#6c5ce7']
                });

                // Side bursts
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0, y: 0.5 },
                        colors: ['#ff6b9d', '#4facfe']
                    });
                }, 200);

                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1, y: 0.5 },
                        colors: ['#ffeaa7', '#fd79a8']
                    });
                }, 400);

                // Heart-shaped confetti
                setTimeout(() => {
                    for (let i = 0; i < 20; i++) {
                        setTimeout(() => {
                            confetti({
                                particleCount: 1,
                                startVelocity: 0,
                                ticks: 200,
                                gravity: 0.3,
                                origin: {
                                    x: Math.random(),
                                    y: Math.random() - 0.2
                                },
                                shapes: ['heart'],
                                colors: ['#ff6b9d', '#fd79a8', '#e84393']
                            });
                        }, i * 50);
                    }
                }, 600);
            }

            // Mouse events
            container.addEventListener('mousedown', (e) => {
                if (currentCardIndex >= cards.length) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startTime = Date.now();
                const card = cards[currentCardIndex];
                card.classList.add('dragging');
                card.style.transition = 'none';
            });

            container.addEventListener('mousemove', (e) => {
                if (!isDragging || currentCardIndex >= cards.length) return;
                currentX = e.clientX - startX;
                currentY = e.clientY - startY;
                velocity = currentX / (Date.now() - startTime);

                const card = cards[currentCardIndex];
                updateCardTransform(card, currentX, currentY);
            });

            container.addEventListener('mouseup', () => {
                if (!isDragging || currentCardIndex >= cards.length) return;
                isDragging = false;
                const card = cards[currentCardIndex];
                card.classList.remove('dragging');
                card.style.transition = 'transform 0.6s cubic-bezier(0.23, 1, 0.320, 1), opacity 0.6s ease';

                if (Math.abs(currentX) > SWIPE_THRESHOLD) {
                    handleSwipe(currentX > 0 ? 'right' : 'left', velocity);
                } else {
                    handleBounceBack(card);
                }
            });

            // Touch events
            container.addEventListener('touchstart', (e) => {
                if (currentCardIndex >= cards.length) return;
                isDragging = true;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startTime = Date.now();
                const card = cards[currentCardIndex];
                card.classList.add('dragging');
                card.style.transition = 'none';
            });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging || currentCardIndex >= cards.length) return;
                currentX = e.touches[0].clientX - startX;
                currentY = e.touches[0].clientY - startY;
                velocity = currentX / (Date.now() - startTime);

                const card = cards[currentCardIndex];
                updateCardTransform(card, currentX, currentY);
            });

            container.addEventListener('touchend', () => {
                if (!isDragging || currentCardIndex >= cards.length) return;
                isDragging = false;
                const card = cards[currentCardIndex];
                card.classList.remove('dragging');
                card.style.transition = 'transform 0.6s cubic-bezier(0.23, 1, 0.320, 1), opacity 0.6s ease';

                if (Math.abs(currentX) > SWIPE_THRESHOLD) {
                    handleSwipe(currentX > 0 ? 'right' : 'left', velocity);
                } else {
                    handleBounceBack(card);
                }
            });

            // Button clicks
            dislikeBtn.addEventListener('click', () => handleSwipe('left'));
            likeBtn.addEventListener('click', () => handleSwipe('right'));

            // Prevent context menu on right click
            container.addEventListener('contextmenu', (e) => e.preventDefault());

            // Initialize
            updateCardVisibility();
        });
    </script>
}